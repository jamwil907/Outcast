pipeline {
    agent any

    environment {
        EMAIL_RECIPIENT = 'jamwil907@gmail.com'
        MONITORING_DIR = 'monitoring'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Container') {
            steps {
                script {
                    echo "=== Building Docker Container ==="
                    sh 'chmod +x build-container.sh'
                    sh 'mkdir -p $MONITORING_DIR'
                    sh 'echo "Build Container Stage Start: $(date)" >> $MONITORING_DIR/build_metrics.txt'
                    sh './build-container.sh'
                    sh 'echo "Build Container Stage End: $(date)" >> $MONITORING_DIR/build_metrics.txt'
                }
            }
        }

        stage('PHP Lint') {
            steps {
                script {
                    echo "=== Running PHP Lint ==="
                    sh 'echo "PHP Lint Stage Start: $(date)" >> $MONITORING_DIR/build_metrics.txt'
                    sh 'find . -name "*.php" -exec php -l {} \\;'
                    sh 'echo "PHP Lint Stage End: $(date)" >> $MONITORING_DIR/build_metrics.txt'
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    echo "=== Running Tests ==="
                    sh 'echo "Tests Stage Start: $(date)" >> $MONITORING_DIR/build_metrics.txt'
                    sh 'php test_weather.php'
                    sh 'echo "Tests Stage End: $(date)" >> $MONITORING_DIR/build_metrics.txt'
                }
            }
        }

        stage('Additional Monitoring Test') {
            steps {
                script {
                    echo "=== Running Additional Monitoring Test ==="
                    sh 'echo "Monitoring Stage Start: $(date)" >> $MONITORING_DIR/build_metrics.txt'

                    // Docker check
                    sh '''
                    if command -v docker >/dev/null 2>&1; then
                        if docker info >/dev/null 2>&1; then
                            echo "Docker is running properly." >> $MONITORING_DIR/build_metrics.txt
                        else
                            echo "WARNING: Docker command found but daemon not accessible." >> $MONITORING_DIR/build_metrics.txt
                        fi
                    else
                        echo "WARNING: Docker not installed." >> $MONITORING_DIR/build_metrics.txt
                    fi
                    '''

                    // PHP CLI check
                    sh '''
                    if command -v php >/dev/null 2>&1; then
                        echo "PHP CLI is installed: $(php -v | head -n 1)" >> $MONITORING_DIR/build_metrics.txt
                    else
                        echo "WARNING: PHP CLI not installed." >> $MONITORING_DIR/build_metrics.txt
                    fi
                    '''

                    // Disk usage
                    sh 'echo "Disk Usage:" >> $MONITORING_DIR/build_metrics.txt'
                    sh 'df -h >> $MONITORING_DIR/build_metrics.txt'

                    // CPU and memory usage
                    sh 'echo "CPU and Memory Usage:" >> $MONITORING_DIR/build_metrics.txt'
                    sh 'top -b -n 1 | head -n 15 >> $MONITORING_DIR/build_metrics.txt'

                    sh 'echo "Monitoring Stage End: $(date)" >> $MONITORING_DIR/build_metrics.txt'
                }
            }
        }
    }

    post {
        always {
            // Archive monitoring logs
            archiveArtifacts artifacts: "$MONITORING_DIR/**/*", allowEmptyArchive: true

            // Send summary email
            emailext(
                to: "${EMAIL_RECIPIENT}",
                subject: "COMPLETED: ${env.JOB_NAME} #${env.BUILD_NUMBER} â€” ${currentBuild.currentResult}",
                body: """\
Build Completed.
Job: ${env.JOB_NAME}
Build #: ${env.BUILD_NUMBER}
Status: ${currentBuild.currentResult}
URL: ${env.BUILD_URL}

Stage timing and monitoring logs archived in $MONITORING_DIR.
"""
            )

            // Optional Slack notification
            // slackSend(channel: '#ci-alerts', message: "Build ${env.JOB_NAME} #${env.BUILD_NUMBER} finished with status ${currentBuild.currentResult}")
        }

        success {
            echo "Build succeeded! Metrics and logs archived."
        }

        failure {
            echo "Build failed! Alerts sent."
        }
    }
