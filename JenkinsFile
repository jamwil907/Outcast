pipeline {
    agent any

    environment {
        EMAIL_RECIPIENT = 'jamwil907@gmail.com'
        MONITORING_DIR = 'monitoring'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Monitoring Directory') {
            steps {
                sh 'mkdir -p $MONITORING_DIR'
                sh 'echo "Monitoring Started: $(date)" > $MONITORING_DIR/build_metrics.txt'
            }
        }

        stage('Build Container') {
            steps {
                script {
                    sh 'chmod +x build-container.sh'
                    sh './build-container.sh'
                }
            }
        }

        stage('PHP Lint (Docker-based)') {
            steps {
                script {
                    sh '''
                    echo "Running PHP lint inside Docker..."
                    for file in $(find . -name "*.php"); do
                        echo "Linting $file"
                        docker run --rm \
                            -v $PWD:/app \
                            -w /app \
                            php:8.2-cli php -l "$file" || exit 1
                    done
                    '''
                }
            }
        }

        stage('Run PHP Tests (Docker-based)') {
            steps {
                script {
                    sh '''
                    echo "Running PHP tests inside Docker..."

                    docker run --rm \
                        -v $PWD:/app \
                        -w /app \
                        php:8.2-cli php test_weather.php
                    '''
                }
            }
        }

        stage('Additional Monitoring Test') {
            steps {
                script {
                    echo "=== Running Additional Monitoring Test ==="

                    sh 'echo "Monitoring Stage Start: $(date)" >> $MONITORING_DIR/build_metrics.txt'

                    sh '''
                    if command -v docker >/dev/null 2>&1; then
                        if docker info >/dev/null 2>&1; then
                            echo "Docker is running properly." >> $MONITORING_DIR/build_metrics.txt
                        else
                            echo "WARNING: Docker command found but daemon not accessible." >> $MONITORING_DIR/build_metrics.txt
                        fi
                    else
                        echo "WARNING: Docker not installed on agent." >> $MONITORING_DIR/build_metrics.txt
                    fi
                    '''
                }
            }
        }
    }

    post {
        success {
            emailext(
                to: "${EMAIL_RECIPIENT}",
                subject: "Jenkins Job SUCCESS: ${env.JOB_NAME}",
                body: "Good news! Your Jenkins pipeline completed successfully.\n\nBuild Number: ${env.BUILD_NUMBER}\nProject: ${env.JOB_NAME}"
            )
        }

        failure {
            emailext(
                to: "${EMAIL_RECIPIENT}",
                subject: "Jenkins Job FAILED: ${env.JOB_NAME}",
                body: "Your Jenkins pipeline has FAILED.\n\nCheck console logs for details.\nBuild Number: ${env.BUILD_NUMBER}\nProject: ${env.JOB_NAME}"
            )
        }
    }
}
