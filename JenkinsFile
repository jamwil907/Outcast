pipeline {
    agent any
        options {
        timeout(time: 60, unit: 'SECONDS')
        }
    triggers {
        cron('0 8 * * *')   // Runs once a day
    }
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/jamwil907/JayErvin_M4Assgn1.git' // gitlab repository that utilizes php
                }
    }

        stage('Shell Script Dependency Check') {
            steps {
                sh '''
                    echo "Checking .sh file dependencies..."

                    # Check if the shell script exists
                    if [ -f build-container.sh ]; then
                        echo "Found build-container.sh"

                        # Ensure it is executable
                        if [ ! -x build-container.sh ]; then
                            echo "Making build-container.sh executable"
                            chmod +x build-container.sh
                        fi

                        # Check for syntax errors
                        bash -n build-container.sh || { echo "Syntax error in build-container.sh"; exit 1; }

                        echo "Shell script dependency check passed."
                    else
                        echo "ERROR: build-container.sh not found!"
                        exit 1
                    fi
                '''
            }
        }

        stage('Security Checks') {
            steps {
                echo "=== Security Checks Stage ==="
                sh '''
                    if command -v composer >/dev/null 2>&1; then
                        if [ "$DRY_RUN" = "true" ]; then
                            echo "[DRY-RUN] composer audit"
                        else
                            composer audit || true
                        fi
                    else
                        echo "Composer not available, skipping security checks"
                    fi
                '''
            }
        }

        stage('Test Build Script') {
            steps {
                sh '''
                    echo "Testing build-container.sh..."

                    # Ensure the script exists
                    if [ ! -f build-container.sh ]; then
                        echo "ERROR: build-container.sh not found!"
                        exit 1
                    fi

                    # Ensure executable
                    if [ ! -x build-container.sh ]; then
                        echo "Making build-container.sh executable"
                        chmod +x build-container.sh
                    fi

                    # Syntax check
                    bash -n build-container.sh || { echo "Syntax error in build-container.sh"; exit 1; }

                    echo "Running build-container.sh (dry-run)..."
                    bash build-container.sh || { echo "build-container.sh failed!"; exit 1; }

                    echo "build-container.sh test completed successfully!"
                '''
            }
        }

        stage('Deliver') {
            steps {
                echo 'Deliver....'
                sh '''
                echo "package delivery.."
                '''
            }
        }
    }
    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed. Check the logs for errors."
        }
        always {
            echo "Module 6 Enhancement tests."
        }
    }
}
